name: Frontend – Build, Push & Deploy (STAGING)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

  # FULL ECR URI (example: 7245...amazonaws.com/inaiworlds)
  ECR_REPOSITORY_URI: ${{ secrets.ECR_REPOSITORY }}

  # EC2 instance-id (staging FE instance)
  TARGET_INSTANCE_ID: ${{ secrets.TARGET_INSTANCE_ID }}

  IMAGE_TAG: ${{ github.sha }}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Set up Docker Buildx (docker-container)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Docker Image (STAGING)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ECR_REPOSITORY_URI }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REPOSITORY_URI }}:staging
            ${{ env.ECR_REPOSITORY_URI }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ✅ Auto Deploy: remove old containers + pull latest + run + cleanup old images
      - name: Deploy on EC2 (SSM) - FE auto (cleanup)
        run: |
          aws ssm send-command \
            --region "${{ env.AWS_REGION }}" \
            --instance-ids "${{ env.TARGET_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy inaiworlds FE STAGING (auto + cleanup)" \
            --parameters commands='[
              "set -euo pipefail",
              "echo \"[INFO] Deploy start\"",
              "docker --version",
              "aws --version",
              "echo \"[INFO] ECR login\"",
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $(echo ${{ env.ECR_REPOSITORY_URI }} | cut -d/ -f1)",
              "echo \"[INFO] Pull latest image\"",
              "docker pull ${{ env.ECR_REPOSITORY_URI }}:latest",
              "echo \"[INFO] Remove old containers (if any)\"",
              "docker rm -f inaiworlds 2>/dev/null || true",
              "docker rm -f inaiworlds-fe 2>/dev/null || true",
              "echo \"[INFO] Run new container\"",
              "docker run -d --name inaiworlds --restart unless-stopped -p 3000:80 ${{ env.ECR_REPOSITORY_URI }}:latest",
              "echo \"[INFO] Cleanup old images (unused + dangling)\"",
              "docker image prune -a -f",
              "echo \"[INFO] Status\"",
              "docker ps -a | head -n 25",
              "docker images | head -n 25"
            ]'
